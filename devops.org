* Devops  
  Special thanks to [[https://github.com/wrightmikea/simple-docker-tangle][wrightmikea]]!
  This file is an attempt at *Literate Devops*
** Docker setup                                            :dev:docker:setup:
*** Setup env variables
#+name: setup
#+BEGIN_SRC sh :results output verbatim :session docker
eval "$(docker-machine env default)"
#+END_SRC

#+RESULTS: setup
: Docker machine "default" does not exist. Use "docker-machine ls" to list machines. Use "docker-machine create" to add a new one.

*** Verify Docker works                                    :dev:docker:setup:
#+name: verify-docker
#+BEGIN_SRC sh :results output verbatim replace :session docker
echo "show docker env"
env | grep DOC
docker run --name my-container hello-world
echo "\n"
docker container rm my-container
echo "\n"
#+END_SRC

#+RESULTS: verify-docker
#+begin_example
show docker env
sh-5.0$ 
Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/
\n
my-container
\n
#+end_example

** Server Setup
   :properties:
   :header-args: :var app_name="my-portfolio" username="ec2-user"
   :end:
*** Send Configurations To Server
#+name: send-configurations-to-server
#+begin_src sh :results output verbatim drawer
scp ~/.prod-taggrc tagg:~/.prod-taggrc
#+end_src

#+RESULTS: send-configurations-to-server
:results:
:end:

*** Logging Directory Setup
    :properties:
    :header-args+: :dir /ssh:tagg|sudo:tagg:/var/log
    :end:


 #+begin_src sh :results output drawer
   mkdir $app_name
   touch $app_name/access.log
   touch $app_name/message.log
   chown -R $username:$username $app_name
   chmod 755 $app_name
   whoami
   pwd
   ls -al $app_name
 #+end_src

 #+RESULTS:
 :results:
 root
 /var/log
 total 8
 drwxr-xr-x 2 ec2-user ec2-user 4096 Sep 11 01:37 .
 drwxr-xr-x 8 root     root     4096 Sep 11 01:37 ..
 -rw-r--r-- 1 ec2-user ec2-user    0 Sep 11 01:37 access.log
 -rw-r--r-- 1 ec2-user ec2-user    0 Sep 11 01:37 message.log
 :end:

** Dockerfile Creation and deployment
   :properties:
   :header-args: :var app_name="my-portfolio"
   :end:

*** Generate a Dockerfile for the project
#+name: generate-dockerfile
#+BEGIN_SRC dockerfile :tangle Dockerfile
  FROM daewok/sbcl:alpine

  # COPY ./ /usr/src/app/

  ## TODO Securer install of quicklisp (needs to be updated for alpine (no apt-get))
  # RUN set -x \
  #   && apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt \
  #   && curl "https://beta.quicklisp.org/release-key.txt" > /tmp/quicklisp-release-key.txt \
  #   && curl "https://beta.quicklisp.org/quicklisp.lisp" > /tmp/quicklisp.lisp \
  #   && curl "https://beta.quicklisp.org/quicklisp.lisp.asc" > /tmp/quicklisp.lisp.asc \
  #   && export GNUPGHOME="$(mktemp -d)" \
  #   && gpg --batch --import /tmp/quicklisp-release-key.txt \
  #   && gpg --batch --verify /tmp/quicklisp.lisp.asc /tmp/quicklisp.lisp \
  #   && sync \
  #   && sleep 2 \
  #   && rm -rf "$GNUPGHOME" /tmp/quicklisp.lisp.asc \
  #   && export HOME=/home/lisp \
  #   && sbcl --no-sysinit --no-userinit --non-interactive \
  #   --load /tmp/quicklisp.lisp \
  #   --eval "(quicklisp-quickstart:install)" \
  #   --eval "(ql::without-prompting (dolist (imp '(:sbcl :ccl :abcl :ecl)) (ql:add-to-init-file imp)))" \
  #   && rm -rf /tmp/*

  # FIXME remove this for production (but make available in development?)
  # RUN apk add --no-cache bash

  # FIXME improve security and fingerprinting for quicklisp install...
  RUN cd /tmp && \
    wget https://beta.quicklisp.org/quicklisp.lisp && \
    sbcl --load quicklisp.lisp --quit --eval '(quicklisp-quickstart:install)'

  COPY sbclrc /root/.sbclrc
  COPY ./ /root/my-portfolio/
  RUN ln -s /root/my-portfolio/my-portfolio.asd /root/quicklisp/local-projects/

  EXPOSE 8080

  WORKDIR /root

  ENTRYPOINT ["sbcl", "--eval", "(ql:quickload 'my-portfolio)", "--eval", "(control:start-server)"]

#+END_SRC

*** Docker Build
#+name: build-image
#+BEGIN_SRC sh :results output drawer
   echo "---- Building Docker File -----"
   docker build -t $app_name ./
#+END_SRC

#+RESULTS: build-image
:results:
---- Building Docker File -----
Sending build context to Docker daemon  17.04MB
Step 1/8 : FROM daewok/sbcl:alpine
 ---> 1a8415706b0e
Step 2/8 : RUN cd /tmp &&   wget https://beta.quicklisp.org/quicklisp.lisp &&   sbcl --load quicklisp.lisp --quit --eval '(quicklisp-quickstart:install)'
 ---> Using cache
 ---> 92776b95f0b0
Step 3/8 : COPY sbclrc /root/.sbclrc
 ---> Using cache
 ---> db6a9b481bc1
Step 4/8 : COPY ./ /root/my-portfolio/
 ---> Using cache
 ---> 8db4b17f46ac
Step 5/8 : RUN ln -s /root/my-portfolio/my-portfolio.asd /root/quicklisp/local-projects/
 ---> Using cache
 ---> 879386cc64b4
Step 6/8 : EXPOSE 8080
 ---> Using cache
 ---> 65519bed35e3
Step 7/8 : WORKDIR /root
 ---> Using cache
 ---> effeafce64b8
Step 8/8 : ENTRYPOINT ["sbcl", "--eval", "(ql:quickload 'my-portfolio)", "--eval", "(control:start-server)"]
 ---> Using cache
 ---> 2d2ace48c358
Successfully built 2d2ace48c358
Successfully tagged my-portfolio:latest
:end:

*** Transport Docker Image to Server 
#+name: save-image-and-send-to-server
#+begin_src sh
  docker save -o $app_name.image $app_name
  tar czf $app_name.tar.gz $app_name.image
  rm $app_name.image
  scp $app_name.tar.gz tagg:~
  rm $app_name.tar.gz
  pwd
#+end_src

#+RESULTS: save-image-and-send-to-server
: /home/evan/Downloads/my-portfolio

#+RESULTS:

*** Deploy to server
    :properties:
    :header-args+: :dir /ssh:tagg:~
    :end:

#+name: load-and-run-image
#+begin_src sh
  tar -xf $app_name.tar.gz
  docker load -i $app_name.image
  rm $app_name.tar.gz
  rm $app_name.image

  echo "----- Running Docker Container -----"
  docker stop $app_name
  docker container rm $app_name
  docker run -dt --rm=true \
         -p 8080:8080 \
         --name $app_name \
         -v ~/.prod-taggrc:/root/.prod-taggrc:ro \
         -v /var/log/$app_name:/var/log/$app_name \
         $app_name 

#+end_src

#+RESULTS: load-and-run-image
| [1A[1K[K9ebf511245b7:                                    | Loading | layer               | 196.6kB/17.04MB[1B[1A[1K[K9ebf511245b7: | Loading | layer | 12.19MB/17.04MB[1B[1A[1K[K9ebf511245b7: | Loading | layer               | 13.17MB/17.04MB[1B[1A[1K[K9ebf511245b7: | Loading | layer    | 14.16MB/17.04MB[1B[1A[1K[K9ebf511245b7: | Loading | layer | 17.04MB/17.04MB[1B |    |                                                                         |    |       |        |
| [1A[1K[K22437bae6cd1:                                    | Loading | layer               | 3.072kB/3.072kB[1B[1A[1K[K22437bae6cd1: | Loading | layer | 3.072kB/3.072kB[1BThe                           | image   | my-portfolio:latest | already                                             | exists, | renaming | the                                                 | old     | one   | with                   | ID | sha256:db27134667912401f8d96615c7f03d0342d0a83c12c7ecd5f3167c0c904adf6e | to | empty | string |
| Loaded                                                           | image:  | my-portfolio:latest |                                                     |         |       |                                                     |         |                     |                                                     |         |          |                                                     |         |       |                        |    |                                                                         |    |       |        |
| -----                                                            | Running | Docker              | Container                                           | -----   |       |                                                     |         |                     |                                                     |         |          |                                                     |         |       |                        |    |                                                                         |    |       |        |
| my-portfolio                                                     |         |                     |                                                     |         |       |                                                     |         |                     |                                                     |         |          |                                                     |         |       |                        |    |                                                                         |    |       |        |
| aa95ab354f8cc98d75ff40943955e6b3d8da72679d67ac4908bc873d0c1b6e41 |         |                     |                                                     |         |       |                                                     |         |                     |                                                     |         |          |                                                     |         |       |                        |    |                                                                         |    |       |        |

#+RESULTS:
| [1A[1K[K5f5a836898c0: | Loading | layer              | 458.8kB/44.49MB[1B[1A[1K[K5f5a836898c0: | Loading | layer | 16.06MB/44.49MB[1B[1A[1K[K5f5a836898c0: | Loading | layer              | 30.74MB/44.49MB[1B[1A[1K[K5f5a836898c0: | Loading | layer    | 39.91MB/44.49MB[1B[1A[1K[K5f5a836898c0: | Loading | layer | 40.83MB/44.49MB[1B[1A[1K[K5f5a836898c0: | Loading | layer                                                                   | 41.75MB/44.49MB[1B[1A[1K[K5f5a836898c0: | Loading | layer  | 44.49MB/44.49MB[1B[1A[1K[K5f5a836898c0: | Loading | layer | 44.49MB/44.49MB[1B |
| [1A[1K[K78e10fd83041: | Loading | layer              | 3.072kB/3.072kB[1B[1A[1K[K78e10fd83041: | Loading | layer | 3.072kB/3.072kB[1BThe                           | image   | evan-webapp:latest | already                                             | exists, | renaming | the                                                 | old     | one   | with                                                | ID      | sha256:b92f610fed5ff8471d338966357fffde5fd48885697d335d2f8fbe8a682c3a53 | to                                                  | empty   | string |                                                     |         |       |                        |
| Loaded                        | image:  | evan-webapp:latest |                                                     |         |       |                                                     |         |                    |                                                     |         |          |                                                     |         |       |                                                     |         |                                                                         |                                                     |         |        |                                                     |         |       |                        |

** Local Setup
   :properties:
   :header-args: :var app_name="my-portfolio" username="evan"
   :end:
*** Local Logging Directory Setup
    :properties:
    :header-args+: :dir /sudo::/var/log
    :end:

 #+begin_src sh :results output drawer
   mkdir $app_name
   touch $app_name/access.log
   touch $app_name/message.log
   chown -R $username:$username $app_name
   chmod 755 $app_name
   whoami
   pwd
   ls -al $app_name
 #+end_src

 #+RESULTS:
 :results:
 root
 /var/log
 total 20
 drwxr-xr-x.  2 evan evan 4096 Sep 10 19:44 .
 drwxr-xr-x. 21 root root 4096 Sep 10 19:29 ..
 -rw-r--r--.  1 evan evan 4307 Sep 10 19:52 access.log
 -rw-r--r--.  1 evan evan  119 Sep 10 19:52 message.log
 :end:

*** Build and Run Local
#+name: build-and-run-local
#+BEGIN_SRC sh :results output drawer
  echo "---- Building Docker File -----"
  docker build -t $app_name ./
  echo "----- Running Docker Container -----"
  docker stop $app_name
  docker container rm $app_name
  docker run -dt --rm=true \
         -p 8080:8080 \
         --name $app_name \
         -v ~/.prod-taggrc:/root/.prod-taggrc:ro \
         -v /var/log/$app_name:/var/log/$app_name \
         $app_name 
         

#+end_src

#+RESULTS: build-and-run-local
:results:
---- Building Docker File -----
Sending build context to Docker daemon  17.04MB
Step 1/8 : FROM daewok/sbcl:alpine
 ---> 1a8415706b0e
Step 2/8 : RUN cd /tmp &&   wget https://beta.quicklisp.org/quicklisp.lisp &&   sbcl --load quicklisp.lisp --quit --eval '(quicklisp-quickstart:install)'
 ---> Using cache
 ---> 92776b95f0b0
Step 3/8 : COPY sbclrc /root/.sbclrc
 ---> Using cache
 ---> db6a9b481bc1
Step 4/8 : COPY ./ /root/my-portfolio/
 ---> Using cache
 ---> 8db4b17f46ac
Step 5/8 : RUN ln -s /root/my-portfolio/my-portfolio.asd /root/quicklisp/local-projects/
 ---> Using cache
 ---> 879386cc64b4
Step 6/8 : EXPOSE 8080
 ---> Using cache
 ---> 65519bed35e3
Step 7/8 : WORKDIR /root
 ---> Using cache
 ---> effeafce64b8
Step 8/8 : ENTRYPOINT ["sbcl", "--eval", "(ql:quickload 'my-portfolio)", "--eval", "(control:start-server)"]
 ---> Using cache
 ---> 2d2ace48c358
Successfully built 2d2ace48c358
Successfully tagged my-portfolio:latest
----- Running Docker Container -----
d56a4841de95be4706ef4e6a5e20ef2791095bebea13b04f7dd991a0b0069887
:end:

** Future Improvemens [0/3]
*** TODO [#A] How do we want to execute main 
**** Start in bash
**** Start with sbcl -eval
**** Create an executable
*** TODO Cache the quicklisp dependencies 
    It would be possilble to link a volume for the dev environment?
    For production we should probably just install everything fresh? Load time is pretty bad though...
*** TODO Monitor for time drift 
    This appears to be a macos problem only.

